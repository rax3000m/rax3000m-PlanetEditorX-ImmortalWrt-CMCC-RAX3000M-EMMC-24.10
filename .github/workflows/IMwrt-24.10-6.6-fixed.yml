name: IMwrt-24.10-6.6-fixed

on:
  repository_dispatch:
    types: [build_firmware]
  push:
  #   branches: [ main ]
  workflow_dispatch:
    inputs:
      device_model:
        description: 'é€‰æ‹©ç›®æ ‡è®¾å¤‡å‹å·'
        type: choice
        required: true
        options:
          - cmcc_rax3000m-emmc
      LAN_IP:
        description: 'è®¾ç½® LAN IP åœ°å€'
        required: true
        default: '192.168.0.1'
      enable_5g_25db:
        description: 'å¯ç”¨ 5G 25dB ä¿®æ”¹'
        type: boolean
        required: true
        default: true
      upload_bin_dir:
        description: 'ä¸Šä¼  bin ç›®å½•'
        type: boolean
        required: true
        default: true
      repo_url:
        description: 'æºä»“åº“ URL'
        default: 'https://github.com/rax3000m/padavanonly-immortalwrt-mt798x-6.6-Fixed'
        type: choice
        options:
          - 'https://github.com/rax3000m/padavanonly-immortalwrt-mt798x-6.6-Fixed'
          - 'https://github.com/padavanonly/immortalwrt-mt798x-6.6'
      repo_branch:
        description: 'æºä»“åº“åˆ†æ”¯'
        default: 'openwrt-24.10-6.6-Fixed'
        type: choice
        options:
          - 'openwrt-24.10-6.6-Fixed'
          - 'openwrt-24.10-6.6'
      config_file:
        description: 'é…ç½®æ–‡ä»¶'
        default: '24.10-6.6.config'
        type: choice
        options:
          - '24.10-6.6.config'
      istore:
        description: 'é›†æˆiStoreå•†åº—'
        type: boolean
        required: true
        default: false
      ssh:
        description: 'SSH connection to Actions'
        type: boolean
        required: true
        default: true

  schedule:
    - cron: '0 16 * * *' # åŒ—äº¬æ—¶é—´æ¯å¤©00:00

permissions:
  contents: write
  actions: write

env:
  REPO_URL: ${{ github.event.inputs.repo_url || 'https://github.com/rax3000m/padavanonly-immortalwrt-mt798x-6.6-Fixed' }}
  REPO_BRANCH: ${{ github.event.inputs.repo_branch || 'openwrt-24.10-6.6-Fixed' }}
  FEEDS_CONF: config/feeds.conf.default
  CONFIG_FILE: ${{ github.event.inputs.config_file || '24.10-6.6.config' }}
  DIY_P1_SH: scripts/24.10-6.6/diy-part1.sh
  DIY_P2_SH: scripts/24.10-6.6/diy-part2.sh
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai
  ENABLE_5G_25DB: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.enable_5g_25db || secrets.ENABLE_5G_25DB || 'true' }}
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN  }}
  BUILD_COMMIT_MSGS_FILE: ''
  CHECKED_COMMIT_MSGS_FILE: ''
  BUILD_TIME: $(date +'%Y-%m-%d %H:%M:%S')

jobs:
  check-source-updates:
    runs-on: ubuntu-22.04
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
      latest_commit_message: ${{ steps.check.outputs.LATEST_COMMIT_MESSAGE }}

    steps:
      - name: æ£€å‡ºæœ¬ä»“åº“ä»£ç 
        uses: actions/checkout@v4

      - name: Check Server Performance
        run: |
          echo "è­¦å‘Šâš "
          echo "åˆ†é…çš„æœåŠ¡å™¨æ€§èƒ½æœ‰é™ï¼Œè‹¥é€‰æ‹©çš„æ’ä»¶è¿‡å¤šï¼ŒåŠ¡å¿…æ³¨æ„CPUæ€§èƒ½ï¼"
          echo -e "å·²çŸ¥CPUå‹å·(é™åº): 7763ï¼Œ8370Cï¼Œ8272CLï¼Œ8171Mï¼ŒE5-2673\n"
          echo "--------------------------CPUä¿¡æ¯--------------------------"
          echo "CPUç‰©ç†æ•°é‡: $(cat /proc/cpuinfo | grep "physical id" | sort | uniq | wc -l)"
          echo "CPUæ ¸å¿ƒæ•°é‡: $(nproc)"
          echo -e "CPUå‹å·ä¿¡æ¯:$(cat /proc/cpuinfo | grep -m1 name | awk -F: '{print $2}')\n"
          echo "--------------------------å†…å­˜ä¿¡æ¯--------------------------"
          echo "å·²å®‰è£…å†…å­˜è¯¦ç»†ä¿¡æ¯:"
          echo -e "$(sudo lshw -short -C memory | grep GiB)\n"
          echo "--------------------------ç¡¬ç›˜ä¿¡æ¯--------------------------"
          echo "ç¡¬ç›˜æ•°é‡: $(ls /dev/sd* | grep -v [1-9] | wc -l)" && df -hT

      - name: è®¾ç½® REPO_PATH
        run: echo "REPO_PATH=$(echo $REPO_URL | sed -E 's#https://github.com/##;s#/$##')" >> $GITHUB_ENV

      - name: è·å– last_checked_sha ç¼“å­˜
        id: cache-sha
        uses: actions/cache@v4
        with:
          path: last_checked_sha.txt
          key: ${{ env.REPO_PATH }}-${{ env.REPO_BRANCH }}-last-checked-sha

      - name: å®‰è£… GitHub CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y gh

      - name: æ£€æŸ¥æºä»“åº“æ›´æ–°
        id: check
        run: |
          echo $REPO_PATH
          echo $REPO_BRANCH
          LATEST_URL=$(curl -s -f -H "Accept: application/vnd.github.v3+json" \
          "https://api.github.com/repos/${REPO_PATH}/commits/$REPO_BRANCH" | jq -r '.url' || echo "")
          echo "è·³è½¬URLï¼š" $LATEST_URL
          response=$(curl -s -f -H "Accept: application/vnd.github.v3+json" "$LATEST_URL")
          LATEST_SHA=$(echo "$response" | jq -r '.sha' || echo "")
          # LATEST_COMMIT_MESSAGE=$(echo "$response" | jq -r '.commit.message' || echo "")
          LATEST_COMMIT_MESSAGE=$(echo "$response" | jq -r '.commit.message' | tr -d '\n' || echo "")
          LATEST_COMMIT_MESSAGE=$(echo "$LATEST_COMMIT_MESSAGE" | cut -c1-100) # é™åˆ¶é•¿åº¦
          if [ -z "$LATEST_SHA" ] || [ "$LATEST_SHA" = "null" ]; then
            echo "æ— æ³•è·å–æœ€æ–° SHAï¼Œè·³è¿‡ç¼–è¯‘"
            echo "should_build=false" >> $GITHUB_OUTPUT
            echo "LATEST_COMMIT_MESSAGE=" >> $GITHUB_OUTPUT
          fi
          echo "æºä»“åº“æœ€æ–°æäº¤ sha: $LATEST_SHA"
          echo "LATEST_SHA=$LATEST_SHA" >> $GITHUB_ENV

          LAST_CHECKED_FILE="last_checked_sha.txt"
          LAST_CHECKED_SHA=$(cat "$LAST_CHECKED_FILE" 2>/dev/null || echo "")

          if [ -n "$LAST_CHECKED_SHA" ]; then
              echo "ç¼“å­˜ä¸­æ‰¾åˆ°ä¸Šæ¬¡æ£€æŸ¥çš„ SHAï¼š $LAST_CHECKED_SHA"
          else
              echo "ç¼“å­˜ä¸­æœªæ‰¾åˆ°ä¸Šæ¬¡æ£€æŸ¥çš„ SHA"
          fi

          if [ "$LATEST_SHA" != "$LAST_CHECKED_SHA" ]; then
            echo "æ£€æµ‹åˆ°æºä»“åº“æ›´æ–°ï¼š$LATEST_SHA"
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "$LATEST_SHA" > "$LAST_CHECKED_FILE"
            echo "LATEST_COMMIT_MESSAGE=$LATEST_COMMIT_MESSAGE" >> $GITHUB_OUTPUT
            echo "æœ€æ–°æäº¤ä¿¡æ¯: $LATEST_COMMIT_MESSAGE" # For logging
          else
            echo "æºä»“åº“æ— æ›´æ–°ï¼Œè·³è¿‡ç¼–è¯‘"
            echo "should_build=false" >> $GITHUB_OUTPUT
          fi

  build:
    needs: check-source-updates
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'push' || needs.check-source-updates.outputs.should_build == 'true'
    runs-on: ubuntu-22.04
    name: ç¼–è¯‘ ${{ matrix.device_model }}
    strategy:
      matrix:
        device_model: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.device_model && fromJSON(format('["{0}"]', github.event.inputs.device_model)) || fromJSON('["cmcc_rax3000m-emmc"]') }}
      max-parallel: 18

    # Job çº§åˆ«çš„ç¯å¢ƒå˜é‡ï¼šè¿™äº›å˜é‡ä¼šæ ¹æ®è§¦å‘äº‹ä»¶åŠ¨æ€è®¾ç½®
    env:
      # LAN_IP: å¦‚æœæ˜¯ workflow_dispatch è§¦å‘ï¼Œåˆ™ä½¿ç”¨è¾“å…¥çš„ LAN_IPï¼Œå¦åˆ™ä½¿ç”¨é»˜è®¤å€¼ '192.168.0.1'
      LAN_IP: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.LAN_IP || '192.168.0.1' }}

    steps:
      - name: è°ƒè¯•ä¿¡æ¯
        run: |
          echo "è§¦å‘æ–¹å¼: ${{ github.event_name }}"
          echo "EVENT_TRIGGER_METHOD=${{ github.event_name }}" >> $GITHUB_ENV
          echo "è®¾å¤‡å‹å·: ${{ matrix.device_model }}"
          echo "5G 25dB: ${{ env.ENABLE_5G_25DB }}"
          echo "ä¸Šä¼  bin ç›®å½•: ${{ github.event.inputs.upload_bin_dir }}"
          echo "LAN_IP: $LAN_IP"
          echo "ç¼–è¯‘æ—¶é—´: ${{ env.BUILD_TIME }}"

      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # è·å–å®Œæ•´çš„æäº¤å†å²

      - name: è¾“å‡ºæœ€è¿‘çš„ 5 æ¡æäº¤æ—¥å¿—
        run: git log -n 5

      - name: è®¾ç½® REPO_PATH
        run: echo "REPO_PATH=$(echo $REPO_URL | sed -E 's#https://github.com/##;s#/$##')" >> $GITHUB_ENV

      - name: è·å–ä¸Šæ¬¡æäº¤shaç¼“å­˜
        uses: actions/cache@v4
        with:
          path: last_build_sha.txt
          key: ${{ env.REPO_PATH }}-${{ env.REPO_BRANCH }}-last-build-sha

      - name: è·å– last_checked_sha ç¼“å­˜
        uses: actions/cache@v4
        with:
          path: last_checked_sha.txt
          key: ${{ env.REPO_PATH }}-${{ env.REPO_BRANCH }}-last-checked-sha

      - name: è®¾ç½®æœ€æ–°æäº¤ä¿¡æ¯
        run: |
          if [ -f last_build_sha.txt ]; then
            LAST_BUILD_SHA=$(cat last_build_sha.txt)
            echo "è¯»å–åˆ°ä¸Šæ¬¡æäº¤ SHA: $LAST_BUILD_SHA"
          else
            LAST_BUILD_SHA=""
            echo "last_build_sha.txt æ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ— æ³•è·å–ä¸Šæ¬¡æäº¤ SHA"
          fi

          if [ -z "$LAST_BUILD_SHA" ]; then
            echo "LAST_BUILD_SHA ä¸ºç©ºï¼Œæ— æ³•è·å–ä¸Šæ¬¡æäº¤ä¿¡æ¯"
          else
            # ç”Ÿæˆä¸´æ—¶æ–‡ä»¶
            TEMP_FILE=$(mktemp)
            # ä»ä¸Šæ¬¡æäº¤ SHA åˆ°å½“å‰ HEAD çš„æäº¤ä¿¡æ¯
            git log $LAST_BUILD_SHA..HEAD --pretty=format:"%s" | awk '!a[$0]++' | sed 's/^/- /' > "$TEMP_FILE"
            echo "BUILD_COMMIT_MSGS_FILE=$TEMP_FILE" >> $GITHUB_ENV
          fi
          if [ -z "$TEMP_FILE" ]; then
            echo "æœ¬ä»“åº“æ— æ›´æ–°"
          else
            echo "æœ¬ä»“åº“æ›´æ–°ä¿¡æ¯:"
            cat $TEMP_FILE
          fi

      - name: æ£€æŸ¥ç£ç›˜ç©ºé—´
        run: |
          MIN_SPACE=10
          AVAILABLE=$(df -BG . | tail -1 | awk '{print $4}' | sed 's/G//')
          if [ -z "$AVAILABLE" ] || [ "$AVAILABLE" -lt "$MIN_SPACE" ]; then
            echo "é”™è¯¯ï¼šç£ç›˜ç©ºé—´ä¸è¶³ï¼Œå¯ç”¨ç©ºé—´ ${AVAILABLE}Gï¼Œéœ€è‡³å°‘ ${MIN_SPACE}G"
            exit 1
          fi
          echo "å¯ç”¨ç£ç›˜ç©ºé—´ï¼š${AVAILABLE}G"
          df -hT

      - name: åˆå§‹åŒ–ç¯å¢ƒ
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          sudo apt-get update
          sudo apt-get install -y build-essential ccache cmake curl git gawk gcc-multilib g++-multilib \
            libelf-dev libfuse-dev libglib2.0-dev libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev \
            libncurses5-dev libncursesw5-dev libpython3-dev libreadline-dev libssl-dev libtool \
            ninja-build python3 python3-pyelftools rsync unzip vim wget zlib1g-dev tree
          sudo apt-get autoremove --purge
          sudo apt-get clean
          sudo timedatectl set-timezone "$TZ"
          sudo mkdir -p /workdir
          sudo chown $USER:$GROUPS /workdir

      - name: é…ç½® ccache
        run: |
          echo "export PATH=/usr/lib/ccache:$PATH" >> $GITHUB_ENV
          echo "export CCACHE_DIR=$HOME/.ccache" >> $GITHUB_ENV
          ccache -M 5G

      - name: æ¸…ç†ç£ç›˜ç©ºé—´(Ubuntu)
        uses: jlumbroso/free-disk-space@main
        with:
          # this might remove tools that are actually needed,
          # when set to "true" but frees about 6 GB
          tool-cache: false

          # all of these default to true, but feel free to set to
          # "false" if necessary for your workflow
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          swap-storage: true

      - name: å®‰è£… GitHub CLI
        run: |
          sudo apt-get install -y gh

      - name: å…‹éš†æºç 
        working-directory: /workdir
        run: |
          df -hT $PWD
          if [ -d "/workdir/openwrt" ]; then
            echo "æ£€æµ‹åˆ° openwrt ç›®å½•å·²å­˜åœ¨ï¼Œæ­£åœ¨æ¸…ç†..."
            rm -rf /workdir/openwrt
          fi

          for i in {1..3}; do
            # git clone $REPO_URL -b $REPO_BRANCH openwrt && break
            git clone --depth=1 --single-branch $REPO_URL -b $REPO_BRANCH openwrt && break
            echo "å…‹éš†å¤±è´¥ï¼Œé‡è¯• $i/3"
            sleep 5
          done
          if [ ! -d "/workdir/openwrt" ]; then
            echo "é”™è¯¯ï¼šæºç å…‹éš†å¤±è´¥"
            exit 1
          fi
          ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt

          # åˆ©ç”¨æŒ‚è½½åœ¨ /mnt/ çš„é¢å¤–ç©ºé—´:
          sudo mkdir -p -m 777 /mnt/openwrt/dl /mnt/openwrt/feeds /mnt/openwrt/build_dir
          ln -s /mnt/openwrt/dl /workdir/openwrt/dl
          ln -s /mnt/openwrt/feeds /workdir/openwrt/feeds
          ln -s /mnt/openwrt/build_dir /workdir/openwrt/build_dir
          df -hT

          # mkdir -p /mnt/workspace
          # ln -s /mnt/workspace ./workdir

      - name: ç¼“å­˜ç¼–è¯‘ä¾èµ–
        id: cache-openwrt
        uses: actions/cache@v4
        with:
          path: |
            # /mnt/openwrt/dl
            /workdir/openwrt/dl
            # /mnt/openwrt/feeds
            /workdir/openwrt/feeds
            # /mnt/openwrt/build_dir
            # /workdir/openwrt/build_dir
          key: ${{ runner.os }}-build-${{ env.REPO_URL }}-${{ env.REPO_BRANCH }}-${{ hashFiles('/workdir/openwrt/feeds.conf.default') }}
          restore-keys: |
            ${{ runner.os }}-build-${{ env.REPO_URL }}-${{ env.REPO_BRANCH }}-
            ${{ runner.os }}-build-${{ env.REPO_URL }}

      - name: ğŸ“£ Log Cache Status
        run: |
          if [ "${{ steps.cache-openwrt.outputs.cache-hit }}" == 'true' ]; then
            echo "âœ… Cache HIT: ä½¿ç”¨ç¼“å­˜æˆåŠŸ"
          else
            echo "âŒ Cache MISS: é¦–æ¬¡ç¼–è¯‘æˆ–é…ç½®å·²å˜æ›´ï¼Œæœªå‘½ä¸­ç¼“å­˜"
          fi
          echo "CACHE_HIT=${{ steps.cache.outputs.cache-hit }}" >> $GITHUB_ENV

      - name: è·å–æºç æäº¤ SHA
        run: |
          if [ -f last_checked_sha.txt ]; then
            LAST_CHECKED_SHA=$(cat last_checked_sha.txt)
            echo "è¯»å–åˆ°ä¸Šæ¬¡æäº¤ SHA: $LAST_CHECKED_SHA"
          else
            LAST_CHECKED_SHA=""
            echo "last_checked_sha.txt æ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ— æ³•è·å–ä¸Šæ¬¡æäº¤ SHA"
          fi
          cd /workdir/openwrt
          if [ -z "$LAST_CHECKED_SHA" ]; then
            echo "LAST_CHECKED_SHA ä¸ºç©ºï¼Œæ— æ³•è·å–ä¸Šæ¬¡æäº¤ä¿¡æ¯"
          else
            # ç”Ÿæˆä¸´æ—¶æ–‡ä»¶
            TEMP_FILE=$(mktemp)
            # ä»ä¸Šæ¬¡æäº¤ SHA åˆ°å½“å‰ HEAD çš„æäº¤ä¿¡æ¯
            git log $LAST_CHECKED_SHA..HEAD --pretty=format:"%s" | awk '!a[$0]++' | sed 's/^/- /' > "$TEMP_FILE"
            echo "CHECKED_COMMIT_MSGS_FILE=$TEMP_FILE" >> $GITHUB_ENV
          fi
          if [ -z "$TEMP_FILE" ]; then
            echo "æºä»“åº“æ— æ›´æ–°"
          else
            echo "æºä»“åº“æ›´æ–°ä¿¡æ¯:"
            cat $TEMP_FILE
          fi
          echo "è¾“å‡ºæºä»“åº“æœ€è¿‘çš„ 5 æ¡æäº¤æ—¥å¿—"
          git log -n 5
          echo "å­˜å…¥æºä»“åº“æœ€æ–°æäº¤ä¿¡æ¯åˆ°æ–‡ä»¶"
          echo "$(git rev-parse HEAD)" > /workdir/last_checked_sha.txt

      - name: ç§»åŠ¨æ–‡ä»¶åˆ°æ ¹ç›®å½•
        run: |
          mv /workdir/last_checked_sha.txt ./last_checked_sha.txt
          cat last_checked_sha.txt

      - name: åŠ è½½ Feeds
        timeout-minutes: 10
        run: |
          [ -e $FEEDS_CONF ] && mv $FEEDS_CONF openwrt/feeds.conf.default
          chmod +x $DIY_P1_SH
          cd openwrt
          $GITHUB_WORKSPACE/$DIY_P1_SH

      - name: æ›´æ–° Feeds
        timeout-minutes: 30
        run: |
          cd openwrt
          ./scripts/feeds update -a || { echo "æ›´æ–° Feeds å¤±è´¥"; exit 1; }
          ./scripts/feeds install -a || { echo "å®‰è£… Feeds å¤±è´¥"; exit 1; }

          # cat feeds/luci/applications/luci-app-cifs/luasrc/view/cifs_status.htm
          echo "ä¿®æ­£cifsçš„å±•ç¤º"
          mkdir -p feeds/luci/applications/luci-app-cifs/luasrc/view/cifs
          cp feeds/luci/applications/luci-app-cifs/luasrc/view/cifs_status.htm feeds/luci/applications/luci-app-cifs/luasrc/view/cifs/cifs_status.htm

          #æ·»åŠ ç¼–è¯‘æ—¥æœŸæ ‡è¯†
          echo "æ·»åŠ ç¼–è¯‘æ—¥æœŸæ ‡è¯†"
          sed -i "s/\(boardinfo\.model + cpubench\.cpubench\)/(\1) + '  ç¼–è¯‘æ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')'/g" $(find ./feeds/luci/modules/luci-mod-status/ -type f -name "10_system.js")
          # cat feeds/luci/modules/luci-mod-status/htdocs/luci-static/resources/view/status/include/10_system.js

      - name: ä¿®æ”¹daemon.json,åœ¨dockerçš„daemon.jsonä¸­å¢åŠ é•œåƒ
        run: |
          #åœ¨dockerçš„daemon.jsonä¸­å¢åŠ é•œåƒ

          cd openwrt
          # åœ¨æŒ‡å®šç›®å½•ä¸‹æŸ¥æ‰¾ daemon.json æ–‡ä»¶
          DAEMON_JSON_PATH=$(find ./feeds/luci/applications/luci-app-docker/root/etc/docker/ -type f -name "daemon.json" | head -n 1)

          # æ£€æŸ¥æ˜¯å¦æ‰¾åˆ° daemon.json
          if [ -z "$DAEMON_JSON_PATH" ]; then
            echo "é”™è¯¯ï¼šåœ¨feeds/luci/applications/luci-app-docker/root/etc/docker/æ²¡æœ‰æ‰¾åˆ°daemon.json "
            exit 1
          fi

          # å¤‡ä»½åŸå§‹æ–‡ä»¶
          cp "$DAEMON_JSON_PATH" "${DAEMON_JSON_PATH}.bak"

          # ç¬¬ä¸€æ­¥ï¼šæ›¿æ¢ "log-level": "warn" ä¸º "log-level": "warn",ï¼Œç¡®ä¿é€—å·åœ¨åŒä¸€è¡Œ
          sed -i 's/"log-level": "warn"/"log-level": "warn",/' "$DAEMON_JSON_PATH"

          # ç¬¬äºŒæ­¥ï¼šåœ¨ "log-level": "warn", åè¿½åŠ  registry-mirrors å­—æ®µ
          sed -i '/"log-level": "warn",/a\  "registry-mirrors": [\n    "https://docker.aityp.com/",\n    "https://docker.1ms.run",\n    "https://lispy.org/",\n    "https://docker.m.daocloud.io",\n    "https://docker.1panel.live",\n    "https://registry.cn-hangzhou.aliyuncs.com"\n  ]' "$DAEMON_JSON_PATH"

          # å±•ç¤ºä¿®æ”¹åçš„ daemon.json å†…å®¹
          echo "å±•ç¤ºä¿®æ”¹åçš„ daemon.json å†…å®¹ï¼š"
          cat "$DAEMON_JSON_PATH"

      - name: å®‰è£…iStoreå•†åº—
        if: (github.event.inputs.istore == 'true')
        run: |
          cd openwrt
          echo >> feeds.conf.default
          echo 'src-git istore https://github.com/linkease/istore;main' >> feeds.conf.default
          ./scripts/feeds update istore
          ./scripts/feeds install -d y -p istore luci-app-store

      - name: åŠ è½½é…ç½®
        run: |
          [ -e files ] && mv files openwrt/files
          [ -e config/$CONFIG_FILE ] && mv config/$CONFIG_FILE openwrt/.config
          echo "CONFIG_TARGET_mediatek_filogic_DEVICE_${{ matrix.device_model }}=y" >> openwrt/.config
          chmod +x $DIY_P2_SH
          pwd
          ls -la
          cd openwrt
          $GITHUB_WORKSPACE/$DIY_P2_SH
          make defconfig
          # cat .config
          cp .config upload.config
          # cat /etc/docker/daemon.json
          ls -la
          cd files
          pwd
          ls -la

      - name: ä¸‹è½½è½¯ä»¶åŒ…
        id: package
        timeout-minutes: 30
        run: |
          cd openwrt
          make download -j8 || { echo "ä¸‹è½½è½¯ä»¶åŒ…å¤±è´¥"; exit 1; }
          find dl -size -1024c -exec rm -f {} \;

      - name: ä¿®æ”¹ 5G 25dB
        if: env.ENABLE_5G_25DB == 'true'
        working-directory: ./openwrt
        run: |
          EEPROM_FILE=$(find package -name MT7981_iPAiLNA_EEPROM.bin 2>/dev/null | head -n 1)
          if [ -z "$EEPROM_FILE" ]; then
            echo "é”™è¯¯ï¼šæœªæ‰¾åˆ° EEPROM æ–‡ä»¶"
            exit 1
          fi
          EXPECTED_CONTENT=$(printf '\x2B\x2B\x2B\x2B\x2B\x2B\x2B\x2B\x2B\x2B\x2B\x2B\x2B\x2B\x2B\x2B\x2B\x2B\x2B\x2B')
          CURRENT_CONTENT=$(dd if="$EEPROM_FILE" bs=1 skip=$((0x445)) count=20 2>/dev/null || echo "")
          if [ "$CURRENT_CONTENT" != "$EXPECTED_CONTENT" ]; then
            printf '\x2B\x2B\x2B\x2B\x2B\x2B\x2B\x2B\x2B\x2B\x2B\x2B\x2B\x2B\x2B\x2B\x2B\x2B\x2B\x2B' | dd of="$EEPROM_FILE" bs=1 seek=$((0x445)) conv=notrunc
            echo "EEPROM æ–‡ä»¶å·²æ›´æ–°: $EEPROM_FILE"
          else
            echo "EEPROM æ–‡ä»¶æ— éœ€ä¿®æ”¹: $EEPROM_FILE"
          fi

      - name: è®¾ç½®LAN IPåœ°å€ï¼ˆè·¯ç”±å™¨ç™»å½•åœ°å€ï¼‰
        run: |
          cd openwrt
          SET_IP="${{ env.LAN_IP }}" # æˆ–è€…æ›´ç®€æ´åœ°å†™æˆ SET_IP="$LAN_IP"
          if [[ $SET_IP =~ ^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$ ]]; then
              #ä¿®æ”¹immortalwrt.lanå…³è”IP
              sed -i "s/192\.168\.[0-9]*\.[0-9]*/$SET_IP/g" $(find feeds/luci/modules/luci-mod-system -type f -name "flash.js")
              #ä¿®æ”¹é»˜è®¤IPåœ°å€
              sed -i "s/192\.168\.[0-9]*\.[0-9]*/$SET_IP/g" package/base-files/files/bin/config_generate
            echo "è®¾ç½® LAN IP åœ°å€: $SET_IP"
          else
              echo "é”™è¯¯ï¼šLAN IP åœ°å€ ($SET_IP) æ— æ•ˆã€‚å°†ä½¿ç”¨é»˜è®¤é…ç½®ã€‚"
          fi

      - name: SSHé“¾æ¥ç®¡ç†
        uses: P3TERX/ssh2actions@v1.0.0
        if: (github.event.inputs.ssh == 'true')

      # - name: ä¸Šä¼  feeds
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: OpenWrt_feeds
      #     path: |
      #       openwrt/feeds

      - name: ä¸Šä¼  .config
        uses: actions/upload-artifact@v4
        #if: (github.event.inputs.ssh == 'true')
        with:
          name: OpenWrt_config
          path: openwrt/*.config

      - name: åˆ—å‡ºæ‰€æœ‰ feed åŒ…
        run: |
          cd openwrt
          ./scripts/feeds update -a 
          echo "åˆ—å‡ºæ‰€æœ‰ feed åŒ…:"
          ./scripts/feeds list | tee all_feed_packages.txt
          echo "Feed packages list saved to all_feed_packages.txt"

      - name: ä¸Šä¼  feed åŒ…æ—¥å¿—
        uses: actions/upload-artifact@v4
        with:
          name: all-feed-packages
          path: openwrt/all_feed_packages.txt
          retention-days: 5

      - name: Get Version Info
        id: versions
        working-directory: ./openwrt
        run: |
          # è·å–å›ºä»¶ç‰ˆæœ¬
          # FW_VERSION=$(grep 'REVISION:=' include/version.mk | cut -d'=' -f2 | xargs)
          # echo "FW_VERSION=${FW_VERSION}" >> $GITHUB_OUTPUT

          if [ ! -f include/version.mk ]; then
            echo "Error: include/version.mk not found"
            # exit 1
          fi
          FW_VERSION=$(awk -F ':=' '/VERSION_NUMBER:=/ {print $2}' include/version.mk | xargs)
          if [ -z "$FW_VERSION" ]; then
            echo "Error: Failed to extract VERSION_NUMBER"
            # exit 1
          fi
          echo "FW_VERSION=${FW_VERSION}" >> $GITHUB_OUTPUT

          # è·å–å†…æ ¸ç‰ˆæœ¬ (ä» .config æ–‡ä»¶)
          KERNEL_CONFIG_LINE=$(grep 'CONFIG_LINUX_.*=y' .config | grep -E 'CONFIG_LINUX_[0-9]+_[0-9]+=y' | head -n1)
          KERNEL_VERSION=$(echo $KERNEL_CONFIG_LINE | sed -e 's/CONFIG_LINUX_//' -e 's/=y//' -e 's/_/./')
          echo "KERNEL_VERSION=${KERNEL_VERSION}" >> $GITHUB_OUTPUT

          echo "å›ºä»¶ç‰ˆæœ¬: ${FW_VERSION}"
          echo "å†…æ ¸ç‰ˆæœ¬: ${KERNEL_VERSION}"

      - name: Extract and Display Kernel Version
        id: get_kernel_version
        run: |
          cd openwrt
          # æ£€æŸ¥ .config æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -f ".config" ]; then
            echo "é”™è¯¯: .config æ–‡ä»¶æœªæ‰¾åˆ°ã€‚è¯·ç¡®ä¿åœ¨è¿è¡Œæ­¤æ­¥éª¤ä¹‹å‰å·²ç”Ÿæˆé…ç½®æ–‡ä»¶ã€‚"
            #exit 1
          fi

          # æ­¥éª¤ 1: ä» .config æ–‡ä»¶ä¸­è¯»å–å½“å‰é…ç½®çš„å†…æ ¸ä¸»ç‰ˆæœ¬
          # æˆ‘ä»¬æŸ¥æ‰¾ CONFIG_TARGET_KERNEL_PARTSIZE æˆ–ç±»ä¼¼çš„å˜é‡æ¥ç¡®å®šç‰ˆæœ¬
          # å¹¶ç”¨ cut å’Œ tr å‘½ä»¤æå–å‡ºçº¯å‡€çš„ç‰ˆæœ¬å·ï¼Œä¾‹å¦‚ "6.6"
          BASE_VER=$(grep 'CONFIG_TARGET_KERNEL_PARTSIZE' .config | cut -d'=' -f2 | tr -d '"')

          if [ -z "$BASE_VER" ]; then
            echo "é”™è¯¯: æ— æ³•ä» .config æ–‡ä»¶ä¸­ç¡®å®šå†…æ ¸ç‰ˆæœ¬ã€‚"
            #exit 1
          fi

          # æ­¥éª¤ 2: æ„å»ºå†…æ ¸ç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶çš„å®Œæ•´è·¯å¾„
          KERNEL_CONFIG_FILE="include/kernel-${BASE_VER}"

          if [ ! -f "$KERNEL_CONFIG_FILE" ]; then
            echo "é”™è¯¯: å†…æ ¸ç‰ˆæœ¬æ–‡ä»¶ '$KERNEL_CONFIG_FILE' æœªæ‰¾åˆ°ï¼"
            #exit 1
          fi

          # æ­¥éª¤ 3: ä»ç‰ˆæœ¬æ–‡ä»¶ä¸­æå–è¡¥ä¸ç‰ˆæœ¬å·
          PATCH_VER=$(grep "LINUX_VERSION-${BASE_VER}" "$KERNEL_CONFIG_FILE" | cut -d'=' -f2 | tr -d ' ')

          # æ­¥éª¤ 4: æ‹¼æ¥æˆå®Œæ•´ç‰ˆæœ¬å·
          FULL_KERNEL_VERSION="${BASE_VER}${PATCH_VER}"

          echo "å·²é€‰å®šå†…æ ¸ç‰ˆæœ¬ (From .config): ${BASE_VER}"
          echo "å†…æ ¸è¡¥ä¸ç‰ˆæœ¬ (Patch): ${PATCH_VER}"
          echo "å®Œæ•´å†…æ ¸ç‰ˆæœ¬ (Full): ${FULL_KERNEL_VERSION}"

          # è®¾ç½®ä¸ºè¾“å‡º
          echo "kernel_version=${FULL_KERNEL_VERSION}" >> $GITHUB_OUTPUT

      - name: Modify nfs-kernel-server Makefile
        run: |
          cd openwrt
          if [ -f "feeds/packages/net/nfs-kernel-server/Makefile" ]; then
            if ! grep -q "-Wno-error=format-nonliteral" feeds/packages/net/nfs-kernel-server/Makefile; then
              sed -i '/TARGET_CFLAGS +=.*\\$/a\\t\t -Wno-error=format-nonliteral \\' feeds/packages/net/nfs-kernel-server/Makefile
            else
              echo "Flag -Wno-error=format-nonliteral already exists, skipping modification."
            fi
            # echo "Modify nfs-kernel-server Makefile:"
            # cat feeds/packages/net/nfs-kernel-server/Makefile
          else
            echo "Error: Makefile not found at feeds/packages/net/nfs-kernel-server/Makefile"
            exit 1
          fi

      - name: ç¼–è¯‘å‰æ£€æŸ¥ç£ç›˜ç©ºé—´
        run: |
          MIN_SPACE=10
          AVAILABLE=$(df -BG . | tail -1 | awk '{print $4}' | sed 's/G//')
          if [ -z "$AVAILABLE" ] || [ "$AVAILABLE" -lt "$MIN_SPACE" ]; then
            echo "é”™è¯¯ï¼šç£ç›˜ç©ºé—´ä¸è¶³ï¼Œå¯ç”¨ç©ºé—´ ${AVAILABLE}Gï¼Œéœ€è‡³å°‘ ${MIN_SPACE}G"
            exit 1
          fi
          echo "å¯ç”¨ç£ç›˜ç©ºé—´ï¼š${AVAILABLE}G"
          df -hT

      - name: ä¿å­˜ç›®å½•ç»“æ„
        run: |
          pwd
          tree /workdir -a | tee directory-structure.txt
          tree /mnt/openwrt/dl -a | tee openwrt-dl-structure.txt
          tree /mnt/openwrt/feeds -a | tee openwrt-feeds-structure.txt
          tree /mnt/openwrt/build_dir -a | tee openwrt-build_dir-structure.txt
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: directory-structure
          path: |
            directory-structure.txt
            openwrt-*-strstructure.txt

      - name: test Exit workflow
        run: exit 0

      - name: ç¼–è¯‘å›ºä»¶
        id: compile
        timeout-minutes: 360
        run: |
          set -e
          cd openwrt
          echo -e "$(( $(nproc) * 3 / 2 )) çº¿ç¨‹ç¼–è¯‘ï¼Œå¯ç”¨ ccache"
          make -j$(( $(nproc) * 3 / 2 )) CCACHE=1 || make -j1 CCACHE=1 V=s

          # make -j$(nproc) || make -j4 || make -j1 V=s
          echo "status=success" >> $GITHUB_OUTPUT
          echo "DEVICE_NAME=_${{ matrix.device_model }}" >> $GITHUB_ENV
          echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV

      - name: ä¸Šä¼ ç¼–è¯‘æ—¥å¿—
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: compile-log-${{ matrix.device_model }}
          path: |
            openwrt/build_dir/**/*.log
            openwrt/logs/*.log
            openwrt/*.log

      - name: æå–å›ºä»¶ç‰ˆæœ¬å·
        id: version
        if: steps.compile.outputs.status == 'success'
        run: |
          cd openwrt
          # è·å–å½“å‰åˆ†æ”¯æœ€æ–°æäº¤çš„10ä½çŸ­å“ˆå¸Œå€¼
          VERSION=$(git rev-parse --short=10 HEAD || echo "unknown")
          SAFE_VERSION="r${VERSION}"
          echo "æå–çš„ç‰ˆæœ¬å·: $SAFE_VERSION"
          echo "FIRMWARE_VERSION=$SAFE_VERSION" >> $GITHUB_ENV
          echo "status=success" >> $GITHUB_OUTPUT

      - name: æ£€æŸ¥ç£ç›˜
        if: always()
        run: |
          df -hT

      - name: æ•´ç†å›ºä»¶å¹¶å›ºå®šæ–‡ä»¶å
        id: organize
        if: env.UPLOAD_FIRMWARE == 'true' && steps.compile.outputs.status == 'success'
        run: |
          set -e
          cd openwrt/bin/targets/*/*
          rm -rf packages
          ls -la
          if [ "$ENABLE_5G_25DB" = "true" ]; then
            DB25="on"
          else
            DB25="off"
          fi
          DEVICE_MODEL="${{ matrix.device_model }}"
          for file in *sysupgrade* *factory*; do
            if [ -f "$file" ] && ! echo "$file" | grep -q -- "-bl2"; then
              TYPE=$(echo "$file" | grep -o "sysupgrade\|factory")
              EXT="${file##*.}"
              NEW_NAME="${DEVICE_MODEL}_25dB-${DB25}_${FIRMWARE_VERSION}${FILE_DATE}_${TYPE}.${EXT}"
              mv "$file" "$NEW_NAME"
            fi
          done
          echo "FIRMWARE=$PWD" >> $GITHUB_ENV
          echo "status=success" >> $GITHUB_OUTPUT

      - name: ä¸Šä¼  bin
        uses: actions/upload-artifact@v4
        if: steps.compile.outputs.status == 'success' && github.event_name == 'workflow_dispatch' && github.event.inputs.upload_bin_dir == 'true'
        with:
          name: OpenWrt_bin${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
          path: openwrt/bin

      - name: ç”Ÿæˆæ ‡ç­¾å’Œå‘å¸ƒæè¿°
        id: tag
        if: env.UPLOAD_RELEASE == 'true' && steps.compile.outputs.status == 'success'
        run: |
          set -e
          # éªŒè¯å¿…è¦å˜é‡
          if [ -z "${{ matrix.device_model }}" ] || [ -z "${{ env.FIRMWARE_VERSION }}" ]; then
            echo "Missing required variables"
            exit 1
          fi

          # ç”Ÿæˆæ ‡ç­¾
          TAG="ImmortalWrt-24.10-6.6-${{ matrix.device_model }}-${{ env.FIRMWARE_VERSION }}"
          echo "RELEASE_TAG=$TAG-$(date +%Y%m%d%H%M%S)" | tee -a $GITHUB_OUTPUT >> $GITHUB_ENV

          # ç”Ÿæˆå‘å¸ƒè¯´æ˜
          {
            echo "## é»˜è®¤é…ç½®"
            echo "å›ºä»¶ç‰ˆæœ¬: ImmortalWrt ${{ env.FIRMWARE_VERSION }}"
            echo "è®¾å¤‡å‹å·: ${{ matrix.device_model }}"
            echo "ç¼–è¯‘æ—¶é—´: $(date +'%Y-%m-%d %H:%M %Z')"
            echo "é«˜åŠŸç‡æ¨¡å¼: $([ "$ENABLE_5G_25DB" = 'true' ] && echo 'å·²å¯ç”¨' || echo 'æœªå¯ç”¨')"
            echo "åå°åœ°å€: 192.168.0.1 æˆ– http://immortalwrt.lan/"
            echo "æºä»“åº“ URL: $REPO_URL"
            echo "æºä»“åº“åˆ†æ”¯: $REPO_BRANCH"
            echo "é…ç½®æ–‡ä»¶: $CONFIG_FILE"
            echo "è§¦å‘æ–¹å¼: $EVENT_TRIGGER_METHOD"
            if [ -s "$BUILD_COMMIT_MSGS_FILE" ] || [ -s "$CHECKED_COMMIT_MSGS_FILE" ]; then
              echo -e "\n## æ›´æ–°å†…å®¹"

              # æœ¬ä»“åº“è¾“å‡º
              if [ -s "$BUILD_COMMIT_MSGS_FILE" ]; then
                [ -s "$CHECKED_COMMIT_MSGS_FILE" ] && echo "### æœ¬ä»“åº“æ›´æ–°"
                cat "$BUILD_COMMIT_MSGS_FILE"
              fi

              # æºä»“åº“è¾“å‡º
              if [ -s "$CHECKED_COMMIT_MSGS_FILE" ]; then
                  [ -s "$BUILD_COMMIT_MSGS_FILE" ] && echo "### æºä»“åº“æ›´æ–°"
                  cat "$CHECKED_COMMIT_MSGS_FILE"
              fi
            fi
            echo -e "\n## éªŒè¯å›ºä»¶"
            echo -e "\n- æœªéªŒè¯"
          }  | tee -a release

          echo "status=success" >> $GITHUB_OUTPUT

      - name: è°ƒè¯•è¾“å‡º
        run: |
          echo "FIRMWAREè·¯å¾„: ${{ env.FIRMWARE }}"
          echo "TAGçŠ¶æ€: ${{ steps.tag.outputs.status }}"
          ls -la ${{ env.FIRMWARE }} || echo "è¾“å‡ºç›®å½•ä¸å­˜åœ¨: ${{ env.FIRMWARE }}"

      - name: åˆ é™¤åŒå tagï¼ˆå¦‚å·²å­˜åœ¨ï¼‰
        run: |
          git push --delete origin $RELEASE_TAG || true
          git tag -d $RELEASE_TAG || true
        continue-on-error: true

      - name: æ£€æŸ¥ release
        run: |
          ls -l ${{ github.workspace }}/release
          cat ${{ github.workspace }}/release
          if [ ! -s ${{ github.workspace }}/release ]; then
            echo "é”™è¯¯ï¼šrelease æ–‡ä»¶ä¸ºç©ºæˆ–ä¸å­˜åœ¨"
            exit 1
          fi

      - name: æ£€æŸ¥ tag æ­¥éª¤è¾“å‡º
        run: |
          echo "tag status: ${{ steps.tag.outputs.status }}"
          echo "RELEASE_TAG: ${{ steps.tag.outputs.RELEASE_TAG }}"
          echo "RELEASE_TAG env: $RELEASE_TAG"

      - name: å‘å¸ƒå›ºä»¶
        uses: softprops/action-gh-release@v2
        if: steps.tag.outputs.status == 'success'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.tag.outputs.RELEASE_TAG }}
          body_path: release
          files: |
            ${{ env.FIRMWARE }}/*sysupgrade*.*

      - name: éªŒè¯Releaseåˆ›å»º
        run: |
          curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN  }}" \
          https://api.github.com/repos/${{ github.repository }}/releases/tags/$RELEASE_TAG | jq .
          if [ $? -ne 0 ]; then
            echo "é”™è¯¯ï¼šRelease åˆ›å»ºå¤±è´¥"
            exit 1
          fi
          echo "Release åˆ›å»ºæˆåŠŸ: $RELEASE_TAG"

      - name: ä¿å­˜æ­¤æ¬¡æäº¤sha
        run: |
          echo "$(git rev-parse HEAD)" > last_build_sha.txt

      - name: æ ¡éªŒç¼“å­˜æ–‡ä»¶
        run: |
          echo "æ£€æŸ¥ last_build_sha.txt æ–‡ä»¶å†…å®¹"
          if [ ! -f last_build_sha.txt ]; then
            echo "é”™è¯¯ï¼šlast_build_sha.txt æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          else
            echo "last_build_sha.txt æ–‡ä»¶å­˜åœ¨"
            cat last_build_sha.txt
          fi
          echo "æ£€æŸ¥ last_checked_sha.txt æ–‡ä»¶å†…å®¹"
          if [ ! -f last_checked_sha.txt ]; then
            echo "é”™è¯¯ï¼šlast_checked_sha.txt æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          else
            echo "last_checked_sha.txt æ–‡ä»¶å­˜åœ¨"
            cat last_checked_sha.txt
          fi

      - name: åˆ é™¤æŒ‡å®šç¼“å­˜
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "å½“å‰çš„ç¼“å­˜åˆ—è¡¨"
          gh cache list
          gh cache delete "${{ env.REPO_PATH }}-${{ env.REPO_BRANCH }}-last-build-sha" \
            --repo ${{ github.repository }}

          gh cache delete "${{ env.REPO_PATH }}-${{ env.REPO_BRANCH }}-last-checked-sha" \
            --repo ${{ github.repository }}
          echo "åˆ é™¤æŒ‡å®šç¼“å­˜åï¼Œå½“å‰çš„ç¼“å­˜åˆ—è¡¨"
          sleep 5  # ç­‰å¾…ç¼“å­˜åˆ é™¤å®Œæˆ
          gh cache list

      - name: ä¿å­˜æ­¤æ¬¡æäº¤shaç¼“å­˜
        uses: actions/cache@v4
        with:
          path: last_build_sha.txt
          key: ${{ env.REPO_PATH }}-${{ env.REPO_BRANCH }}-last-build-sha

      - name: ä¿å­˜ last_checked_sha ç¼“å­˜
        uses: actions/cache@v4
        with:
          path: last_checked_sha.txt
          key: ${{ env.REPO_PATH }}-${{ env.REPO_BRANCH }}-last-checked-sha

      # - name: æ¸…ç†æ—§ Releases
      #   if: steps.tag.outputs.status == 'success'
      #   continue-on-error: true
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN  }}
      #     MATRIX_DEVICE_MODEL: ${{ matrix.device_model }}
      #     CURRENT_RELEASE: ${{ env.RELEASE_TAG }}
      #   run: |
      #     echo "å½“å‰è®¾å¤‡å‹å·: $MATRIX_DEVICE_MODEL"
      #     echo "å½“å‰ä¿ç•™ Release: $CURRENT_RELEASE"
      #     gh --version
      #     RELEASES=$(gh release list --repo ${{ github.repository }} --limit 100 --json name --jq ".[] | select(.name | test(\"ImmortalWrt-24.10-$MATRIX_DEVICE_MODEL\")) | .name")
      #     echo "å¾…åˆ é™¤çš„ Releases: $RELEASES"
      #     if [ -n "$RELEASES" ]; then
      #       for RELEASE in $RELEASES; do
      #         if [ "$RELEASE" = "$CURRENT_RELEASE" ]; then
      #           echo "è·³è¿‡å½“å‰ Release: $RELEASE"
      #           continue
      #         fi
      #         gh release delete "$RELEASE" --yes || { echo "åˆ é™¤ Release $RELEASE å¤±è´¥"; exit 1; }
      #       done
      #     else
      #       echo "æ— éœ€æ¸…ç†æ—§ Releases"
      #     fi

      - name: æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        if: always() # ç¡®ä¿å§‹ç»ˆæ‰§è¡Œ
        run: rm -f ${{ env.BUILD_COMMIT_MSGS_FILE }} ${{ env.CHECKED_COMMIT_MSGS_FILE }}

      # - name: æ¸…ç†æ—§å·¥ä½œæµè¿è¡Œ
      #   if: steps.tag.outputs.status == 'success'
      #   uses: Mattraks/delete-workflow-runs@v2
      #   with:
      #     retain_days: 7
      #     keep_minimum_runs: 2
